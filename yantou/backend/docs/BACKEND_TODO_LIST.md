# 后端开发待办事项清单

## 📊 总体进度

| 阶段 | 状态 | 完成度 |
|------|------|--------|
| Phase 1: 项目初始化和基础架构 | ✅ 已完成 | 100% |
| Phase 2: 用户认证系统 | ⏳ 进行中 | 95% |
| Phase 3: 用户管理模块 | ❌ 未开始 | 0% |
| Phase 4: 权限管理系统 | ❌ 未开始 | 0% |
| Phase 5: 通用功能模块 | ⏳ 部分完成 | 60% |
| Phase 6: API 文档和测试 | ⏳ 部分完成 | 50% |
| Phase 7: 性能优化和安全加固 | ❌ 未开始 | 0% |

**总体完成度**: 约 35%

---

## ✅ 已完成的功能

### Phase 1: 项目初始化和基础架构 ✅ (100%)

- ✅ 项目初始化
- ✅ 环境配置（多环境支持）
- ✅ 数据库配置（PostgreSQL）
- ✅ 核心依赖安装
- ✅ 中间件配置（CORS、日志、异常处理、请求ID、国际化）
- ✅ URL 路由配置
- ✅ 通用工具模块（JWT、验证器、辅助函数）

### Phase 2: 用户认证系统 ⏳ (95%)

#### 已完成：
- ✅ JWT 配置
- ✅ 认证应用开发（序列化器、视图）
- ✅ 认证路由配置
- ✅ 安全增强（登录失败限制、IP 白名单/黑名单、验证码、设备指纹）

#### 待完成：
- ⏳ Phase 2 验收标准测试（需要手动验证）
- ❌ 密码重置功能（前期暂不实现）

### Phase 5: 通用功能模块 ⏳ (60%)

#### 已完成：
- ✅ 统一响应格式 (`apps/common/response.py`)
- ✅ 异常处理 (`apps/common/exceptions.py`)
- ✅ 日志系统（结构化日志、JSON 格式）
- ✅ 国际化支持

#### 待完成：
- ❌ 分页处理（自定义分页类）
- ❌ 过滤和搜索（通用过滤器）
- ❌ 工具函数（部分已实现，但需要整理到 common）
- ❌ 基础模型（BaseModel、AuditLog、SystemConfig）
- ❌ API 限流

### Phase 6: API 文档和测试 ⏳ (50%)

#### 已完成：
- ✅ API 文档生成（drf-spectacular）
- ✅ Swagger UI 和 ReDoc 配置
- ✅ API 文档注释（认证相关 API）
- ✅ 测试框架搭建（pytest）
- ✅ 部分测试用例（健康检查、工具函数、验证器、中间件）

#### 待完成：
- ❌ 认证模块测试（注册、登录、Token 刷新、登出）
- ❌ 用户管理测试（待 Phase 3 完成后）
- ❌ 权限管理测试（待 Phase 4 完成后）
- ❌ 集成测试完善
- ❌ 测试覆盖率提升到 80%+
- ❌ Postman 集合

---

## ❌ 未实现的功能

### Phase 2: 用户认证系统

#### 验收标准（需要测试验证）
- [ ] 用户可以成功注册（功能已实现，需要测试验证）
- [ ] 用户可以成功登录并获取 Token（功能已实现，需要测试验证）
- [ ] Token 可以正常刷新（功能已实现，需要测试验证）
- [ ] 未授权请求返回 401 错误（功能已实现，需要测试验证）
- [ ] 登录失败次数限制生效（功能已实现，需要测试验证）

#### 暂不实现
- [ ] 密码重置功能（涉及邮件功能，前期暂不实现）

---

### Phase 3: 用户管理模块 ❌ (0%)

#### 3.1 用户模型扩展
- [ ] 创建 `UserProfile` 模型
  - [ ] 关联 Django User 模型（OneToOne）
  - [ ] 手机号字段
  - [ ] 头像字段（ImageField）
  - [ ] 部门字段（ForeignKey）
  - [ ] 职位字段
  - [ ] 创建时间、更新时间
- [ ] 创建 `Department` 模型（如需要）
- [ ] 创建数据库迁移文件
- [ ] 执行迁移

#### 3.2 用户序列化器
- [ ] 创建用户列表序列化器 `UserListSerializer`
- [ ] 创建用户详情序列化器 `UserDetailSerializer`
- [ ] 创建用户创建序列化器 `UserCreateSerializer`
- [ ] 创建用户更新序列化器 `UserUpdateSerializer`
- [ ] 创建当前用户信息序列化器 `CurrentUserSerializer`
- [ ] 实现头像上传处理

#### 3.3 用户视图集
- [ ] 创建 `UserViewSet`
  - [ ] `list()` 用户列表（支持分页、过滤、搜索）
  - [ ] `retrieve()` 用户详情
  - [ ] `create()` 创建用户（管理员）
  - [ ] `update()` 更新用户
  - [ ] `partial_update()` 部分更新
  - [ ] `destroy()` 删除用户（软删除）
- [ ] 创建 `CurrentUserView` 获取当前用户信息
- [ ] 创建 `UpdateCurrentUserView` 更新当前用户信息
- [ ] 实现用户状态管理（激活、禁用）

#### 3.4 用户权限控制
- [ ] 创建用户权限类 `UserPermission`
- [ ] 实现权限规则：
  - [ ] 用户可以查看自己的信息
  - [ ] 用户可以更新自己的信息
  - [ ] 只有管理员可以创建/删除用户
  - [ ] 只有管理员可以查看所有用户列表

#### 3.5 用户路由配置
- [ ] 配置用户相关路由
  - [ ] `GET /api/v1/users/` 用户列表
  - [ ] `POST /api/v1/users/` 创建用户
  - [ ] `GET /api/v1/users/{id}/` 用户详情
  - [ ] `PUT /api/v1/users/{id}/` 更新用户
  - [ ] `PATCH /api/v1/users/{id}/` 部分更新
  - [ ] `DELETE /api/v1/users/{id}/` 删除用户
  - [ ] `GET /api/v1/users/me/` 当前用户信息
  - [ ] `PUT /api/v1/users/me/` 更新当前用户信息

#### 3.6 用户查询和过滤
- [ ] 实现用户搜索功能（用户名、邮箱、手机号）
- [ ] 实现用户过滤功能（部门、状态、角色）
- [ ] 实现用户排序功能（创建时间、更新时间）
- [ ] 配置分页（使用自定义分页类）

#### 3.7 文件上传处理
- [ ] 配置媒体文件存储（本地/OSS）
- [ ] 实现头像上传接口
- [ ] 实现文件大小限制
- [ ] 实现文件类型验证
- [ ] 实现图片压缩和缩略图生成

---

### Phase 4: 权限管理系统 ❌ (0%)

#### 4.1 权限模型设计
- [ ] 创建 `Role` 模型
  - [ ] 角色名称、代码、描述
  - [ ] 关联权限（ManyToMany）
  - [ ] 是否激活
  - [ ] 创建时间、更新时间
- [ ] 创建 `UserRole` 模型（用户角色关联）
  - [ ] 用户（ForeignKey）
  - [ ] 角色（ForeignKey）
  - [ ] 分配时间
- [ ] 创建 `Resource` 模型（可选，用于资源级权限）
- [ ] 创建数据库迁移文件
- [ ] 执行迁移

#### 4.2 权限序列化器
- [ ] 创建角色列表序列化器 `RoleListSerializer`
- [ ] 创建角色详情序列化器 `RoleDetailSerializer`
- [ ] 创建角色创建序列化器 `RoleCreateSerializer`
- [ ] 创建角色更新序列化器 `RoleUpdateSerializer`
- [ ] 创建用户角色序列化器 `UserRoleSerializer`
- [ ] 实现权限树形结构序列化（可选）

#### 4.3 角色管理视图
- [ ] 创建 `RoleViewSet`
  - [ ] `list()` 角色列表
  - [ ] `retrieve()` 角色详情
  - [ ] `create()` 创建角色
  - [ ] `update()` 更新角色
  - [ ] `destroy()` 删除角色
- [ ] 创建 `UserRoleViewSet` 用户角色管理
  - [ ] `list()` 获取用户的角色列表
  - [ ] `create()` 为用户分配角色
  - [ ] `destroy()` 移除用户角色

#### 4.4 自定义权限类
- [ ] 创建基础权限类 `BasePermission`
- [ ] 创建角色权限类 `RolePermission`
- [ ] 创建资源权限类 `ResourcePermission`
- [ ] 实现权限检查逻辑
  - [ ] 检查用户是否拥有指定角色
  - [ ] 检查用户是否拥有指定权限
  - [ ] 检查用户是否有资源访问权限

#### 4.5 权限装饰器和中间件
- [ ] 创建权限装饰器 `@require_permission`
- [ ] 创建角色装饰器 `@require_role`
- [ ] 实现权限缓存机制（Redis）
- [ ] 实现权限检查中间件（可选）

#### 4.6 权限路由配置
- [ ] 配置角色相关路由
  - [ ] `GET /api/v1/roles/` 角色列表
  - [ ] `POST /api/v1/roles/` 创建角色
  - [ ] `GET /api/v1/roles/{id}/` 角色详情
  - [ ] `PUT /api/v1/roles/{id}/` 更新角色
  - [ ] `DELETE /api/v1/roles/{id}/` 删除角色
- [ ] 配置用户角色路由
  - [ ] `GET /api/v1/users/{id}/roles/` 用户角色列表
  - [ ] `POST /api/v1/users/{id}/roles/` 分配角色
  - [ ] `DELETE /api/v1/users/{id}/roles/{role_id}/` 移除角色

#### 4.7 权限数据初始化
- [ ] 创建默认角色（超级管理员、管理员、普通用户、访客）
- [ ] 创建默认权限（CRUD 权限）
- [ ] 创建数据迁移脚本
- [ ] 实现权限同步机制（Django Permission）

#### 4.8 权限查询接口
- [ ] 实现获取用户所有权限接口
- [ ] 实现获取用户所有角色接口
- [ ] 实现权限检查接口（前端调用）
- [ ] 实现权限树形结构接口

---

### Phase 5: 通用功能模块 ⏳ (60%)

#### 已完成：
- ✅ 统一响应格式 (`apps/common/response.py`)
- ✅ 异常处理 (`apps/common/exceptions.py`)
- ✅ 日志系统（结构化日志、JSON 格式）
- ✅ 国际化支持

#### 待完成：

##### 5.1 统一响应格式
- ✅ 已实现 `APIResponse` 类
- [ ] 实现分页响应函数 `paginated_response()`（可选）

##### 5.2 异常处理
- ✅ 已实现自定义异常类
- ✅ 已实现全局异常处理中间件
- ✅ 已配置异常处理视图

##### 5.3 日志系统
- ✅ 已配置 Django 日志系统
- ✅ 已创建日志格式配置（JSON 格式）
- ✅ 已实现请求日志记录
- ✅ 已实现错误日志记录
- [ ] 实现操作日志记录（AuditLog）
- [ ] 创建 `AuditLog` 模型
- [ ] 实现日志中间件（已实现请求日志，需要操作日志）

##### 5.4 分页处理
- [ ] 创建 `apps/common/pagination.py`
- [ ] 实现自定义分页类 `CustomPageNumberPagination`
- [ ] 实现游标分页（可选）
- [ ] 配置默认分页设置

##### 5.5 过滤和搜索
- ✅ 已安装 `django-filter`
- [ ] 创建 `apps/common/filters.py`
- [ ] 实现通用过滤器基类
- [ ] 实现日期范围过滤
- [ ] 实现多字段搜索
- [ ] 配置过滤后端（已在 settings 中配置，需要实现具体过滤器）

##### 5.6 工具函数
- ✅ 部分已实现（在 `utils/` 目录）
- [ ] 整理到 `apps/common/utils.py`（可选）
- [ ] 实现文件处理工具函数

##### 5.7 基础模型
- [ ] 创建 `apps/common/models.py`
- [ ] 创建 `BaseModel` 抽象模型
  - [ ] `created_at` 创建时间
  - [ ] `updated_at` 更新时间
  - [ ] `is_deleted` 软删除标记
  - [ ] `deleted_at` 删除时间
- [ ] 创建 `AuditLog` 模型
- [ ] 创建 `SystemConfig` 模型（系统配置）

##### 5.8 API 限流
- [ ] 配置 DRF 限流设置
- [ ] 实现用户级别限流
- [ ] 实现 IP 级别限流
- [ ] 实现接口级别限流
- [ ] 配置限流异常处理

---

### Phase 6: API 文档和测试 ⏳ (50%)

#### 已完成：
- ✅ 安装 `drf-spectacular`
- ✅ 配置 API 文档设置
- ✅ 为认证 API 添加文档注释
- ✅ 配置 Swagger UI
- ✅ 配置 ReDoc
- ✅ 测试框架搭建（pytest）
- ✅ 部分测试用例（健康检查、工具函数、验证器、中间件）

#### 待完成：

##### 6.1 API 文档生成
- ✅ 已基本完成
- [ ] 为所有 API 添加文档注释（待 Phase 3、4 完成后）

##### 6.2 单元测试
- ✅ 已创建测试目录结构
- [ ] 编写认证模块测试
  - [ ] 注册测试
  - [ ] 登录测试
  - [ ] Token 刷新测试
  - [ ] 登出测试
  - [ ] 验证码测试
- [ ] 编写用户管理测试（待 Phase 3 完成后）
- [ ] 编写权限管理测试（待 Phase 4 完成后）
- [ ] 运行测试并修复问题

##### 6.3 集成测试
- [ ] 编写 API 集成测试
- [ ] 编写端到端测试场景
- [ ] 测试认证流程
- [ ] 测试权限控制流程（待 Phase 4 完成后）
- [ ] 测试错误处理

##### 6.4 测试覆盖率
- ✅ 已安装 `coverage`
- ✅ 已配置覆盖率报告
- ✅ 已生成覆盖率报告（当前 72%）
- [ ] 确保覆盖率 > 80%（当前 72%，需要提升）

##### 6.5 API 测试工具
- [ ] 创建 Postman 集合
- [ ] 创建 API 测试脚本
- [ ] 配置自动化测试流程

---

### Phase 7: 性能优化和安全加固 ❌ (0%)

#### 7.1 数据库优化
- [ ] 分析慢查询
- [ ] 添加数据库索引
- [ ] 优化查询语句（select_related, prefetch_related）
- ✅ 已配置数据库连接池
- [ ] 实现查询缓存

#### 7.2 缓存优化
- ✅ 已安装和配置 Redis
- [ ] 实现用户信息缓存
- [ ] 实现权限信息缓存
- [ ] 实现 API 响应缓存（可选）
- [ ] 配置缓存过期策略

#### 7.3 安全加固
- [ ] 配置 HTTPS（生产环境）
- ✅ 已实现 CSRF 保护（Django 内置）
- [ ] 实现 XSS 防护
- ✅ 已配置安全响应头（部分）
- [ ] 实现 SQL 注入防护检查
- ✅ 已配置密码策略（Django 内置）
- [ ] 实现敏感数据加密

#### 7.4 性能监控
- [ ] 集成性能监控工具（Sentry、New Relic）
- [ ] 实现 API 性能日志
- [ ] 配置慢查询监控
- [ ] 实现错误追踪

#### 7.5 部署准备
- [ ] 创建 Dockerfile
- ✅ 已创建 docker-compose.yml（基础版本）
- ✅ 已配置生产环境设置
- ✅ 已配置环境变量
- [ ] 创建部署脚本
- [ ] 配置 Nginx（可选）
- [ ] 配置 Gunicorn/uWSGI

#### 7.6 文档完善
- [ ] 编写部署文档
- [ ] 编写运维文档
- ✅ 已编写 API 使用文档
- [ ] 编写故障排查文档

---

## 🎯 优先级建议

### P0 - 高优先级（核心功能）

1. **Phase 2 验收标准测试**
   - 验证已实现的认证功能是否正常工作
   - 编写认证模块的测试用例

2. **Phase 3: 用户管理模块**
   - 用户模型扩展
   - 用户 CRUD 操作
   - 当前用户信息接口

3. **Phase 4: 权限管理系统**
   - 角色和权限模型
   - 权限分配和管理
   - 权限检查逻辑

### P1 - 中优先级（增强功能）

4. **Phase 5: 通用功能模块补充**
   - 分页处理
   - 过滤和搜索
   - 基础模型
   - API 限流

5. **Phase 6: 测试完善**
   - 认证模块测试
   - 测试覆盖率提升到 80%+
   - 集成测试

### P2 - 低优先级（优化和部署）

6. **Phase 7: 性能优化和安全加固**
   - 数据库优化
   - 缓存优化
   - 安全加固
   - 部署准备

---

## 📝 下一步行动建议

### 立即执行（本周）

1. **完成 Phase 2 验收标准测试**
   - 编写认证模块的测试用例
   - 验证所有认证功能

2. **开始 Phase 3: 用户管理模块**
   - 创建 UserProfile 模型
   - 实现用户 CRUD 操作
   - 实现当前用户信息接口

### 短期计划（1-2 周）

3. **完成 Phase 3: 用户管理模块**
   - 用户序列化器
   - 用户视图集
   - 用户权限控制
   - 文件上传处理

4. **开始 Phase 4: 权限管理系统**
   - 权限模型设计
   - 角色管理

### 中期计划（2-4 周）

5. **完成 Phase 4: 权限管理系统**
6. **完善 Phase 5: 通用功能模块**
7. **完善 Phase 6: 测试**

### 长期计划（1-2 月）

8. **Phase 7: 性能优化和安全加固**

---

## 📊 统计信息

- **总任务数**: 约 200+ 个任务
- **已完成**: 约 70 个任务（35%）
- **进行中**: 约 20 个任务（10%）
- **未开始**: 约 110 个任务（55%）

---

**文档版本**: v1.0.0  
**最后更新**: 2025-12-06  
**下次更新**: Phase 3 完成后

