# Phase 3 & Phase 4 åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº† Phase 3ï¼ˆç”¨æˆ·ç®¡ç†æ¨¡å—ï¼‰å’Œ Phase 4ï¼ˆæƒé™ç®¡ç†ç³»ç»Ÿï¼‰çš„åŠŸèƒ½æµ‹è¯•æƒ…å†µã€‚

## âœ… ä»£ç æ£€æŸ¥ç»“æœ

### ç³»ç»Ÿæ£€æŸ¥
- âœ… Django ç³»ç»Ÿæ£€æŸ¥é€šè¿‡
- âœ… æ—  Linter é”™è¯¯
- âœ… æ‰€æœ‰æ¨¡å‹æ­£ç¡®å¯¼å…¥

### æ¨¡å‹æ£€æŸ¥
- âœ… `UserProfile` æ¨¡å‹æ­£ç¡®
- âœ… `Department` æ¨¡å‹æ­£ç¡®
- âœ… `Role` æ¨¡å‹æ­£ç¡®
- âœ… `Permission` æ¨¡å‹æ­£ç¡®
- âœ… `UserRole` æ¨¡å‹æ­£ç¡®
- âœ… `RolePermission` æ¨¡å‹æ­£ç¡®

## ğŸ“ å·²åˆ›å»ºçš„æµ‹è¯•ç”¨ä¾‹

### Phase 3: ç”¨æˆ·ç®¡ç†æ¨¡å—æµ‹è¯•

#### ç”¨æˆ·ç®¡ç†æµ‹è¯• (`test/api/test_users.py`)

**TestUserViewSet**:
- âœ… `test_list_users_as_admin` - ç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
- âœ… `test_list_users_as_user` - æ™®é€šç”¨æˆ·æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ï¼ˆåªèƒ½çœ‹åˆ°è‡ªå·±ï¼‰
- âœ… `test_create_user_as_admin` - ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·
- âœ… `test_create_user_as_user` - æ™®é€šç”¨æˆ·åˆ›å»ºç”¨æˆ·ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
- âœ… `test_retrieve_user` - è·å–ç”¨æˆ·è¯¦æƒ…
- âœ… `test_update_user` - æ›´æ–°ç”¨æˆ·
- âœ… `test_delete_user` - åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
- âœ… `test_get_current_user` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- âœ… `test_update_current_user` - æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯

**TestDepartmentViewSet**:
- âœ… `test_list_departments` - è·å–éƒ¨é—¨åˆ—è¡¨
- âœ… `test_create_department` - åˆ›å»ºéƒ¨é—¨
- âœ… `test_retrieve_department` - è·å–éƒ¨é—¨è¯¦æƒ…

### Phase 4: æƒé™ç®¡ç†ç³»ç»Ÿæµ‹è¯•

#### æƒé™ç®¡ç†æµ‹è¯• (`test/api/test_permissions.py`)

**TestRoleViewSet**:
- âœ… `test_list_roles_as_admin` - ç®¡ç†å‘˜æŸ¥çœ‹è§’è‰²åˆ—è¡¨
- âœ… `test_list_roles_as_user` - æ™®é€šç”¨æˆ·æŸ¥çœ‹è§’è‰²åˆ—è¡¨ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
- âœ… `test_create_role` - åˆ›å»ºè§’è‰²
- âœ… `test_retrieve_role` - è·å–è§’è‰²è¯¦æƒ…
- âœ… `test_update_role` - æ›´æ–°è§’è‰²
- âœ… `test_delete_role` - åˆ é™¤è§’è‰²ï¼ˆè½¯åˆ é™¤ï¼‰
- âœ… `test_delete_system_role` - åˆ é™¤ç³»ç»Ÿè§’è‰²ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰

**TestUserRoleViewSet**:
- âœ… `test_assign_role` - åˆ†é…è§’è‰²
- âœ… `test_list_user_roles` - è·å–ç”¨æˆ·è§’è‰²åˆ—è¡¨
- âœ… `test_remove_role` - ç§»é™¤è§’è‰²
- âœ… `test_get_user_roles` - è·å–æŒ‡å®šç”¨æˆ·çš„è§’è‰²åˆ—è¡¨

**TestPermissionViewSet**:
- âœ… `test_list_permissions` - è·å–æƒé™åˆ—è¡¨
- âœ… `test_permission_tree` - è·å–æƒé™æ ‘å½¢ç»“æ„

**TestPermissionCheckViewSet**:
- âœ… `test_my_permissions` - è·å–å½“å‰ç”¨æˆ·æƒé™
- âœ… `test_my_roles` - è·å–å½“å‰ç”¨æˆ·è§’è‰²
- âœ… `test_check_permission` - æ£€æŸ¥æƒé™
- âœ… `test_check_role` - æ£€æŸ¥è§’è‰²

### Phase 2: è®¤è¯æ¨¡å—æµ‹è¯•

#### è®¤è¯ API æµ‹è¯• (`test/api/test_auth.py`)

**TestAuthAPI**:
- âœ… `test_register` - ç”¨æˆ·æ³¨å†Œ
- âœ… `test_login` - ç”¨æˆ·ç™»å½•
- âœ… `test_login_invalid_credentials` - ç™»å½•å¤±è´¥ï¼ˆæ— æ•ˆå‡­æ®ï¼‰
- âœ… `test_refresh_token` - åˆ·æ–° Token
- âœ… `test_logout` - ç”¨æˆ·ç™»å‡º
- âœ… `test_get_captcha` - è·å–éªŒè¯ç 

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰ API æµ‹è¯•

```bash
cd backend
python manage.py migrate  # å…ˆè¿è¡Œè¿ç§»
pytest test/api/ -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# ç”¨æˆ·ç®¡ç†æµ‹è¯•
pytest test/api/test_users.py -v

# æƒé™ç®¡ç†æµ‹è¯•
pytest test/api/test_permissions.py -v

# è®¤è¯æµ‹è¯•
pytest test/api/test_auth.py -v
```

### è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
pytest test/api/ --cov=apps --cov-report=html --cov-report=term
```

## âš ï¸ å·²çŸ¥é—®é¢˜

### JWT ä¾èµ–é—®é¢˜

æµ‹è¯•ç¯å¢ƒä¸­å­˜åœ¨ JWT ä¾èµ–ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼š
```
ImportError: cannot import name 'InvalidKeyError' from 'jwt.exceptions'
```

**è§£å†³æ–¹æ¡ˆ**:
1. å‡çº§ `PyJWT` åˆ°æœ€æ–°ç‰ˆæœ¬
2. æˆ–é™çº§ `djangorestframework-simplejwt` åˆ°å…¼å®¹ç‰ˆæœ¬

### æµ‹è¯•ç¯å¢ƒé…ç½®

æµ‹è¯•éœ€è¦å…ˆè¿è¡Œæ•°æ®åº“è¿ç§»ï¼š
```bash
python manage.py migrate --settings=config.settings.testing
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

å½“å‰æµ‹è¯•è¦†ç›–ç‡ï¼ˆéƒ¨åˆ†ï¼‰ï¼š
- ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼šçº¦ 46% (views.py)
- æƒé™ç®¡ç†æ¨¡å—ï¼šå¾…æµ‹è¯•
- è®¤è¯æ¨¡å—ï¼šå¾…æµ‹è¯•

**ç›®æ ‡è¦†ç›–ç‡**: 80%+

## ğŸ“ æµ‹è¯•æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**: è¿è¡Œæµ‹è¯•å‰éœ€è¦å…ˆæ‰§è¡Œè¿ç§»
2. **æµ‹è¯•æ•°æ®**: æµ‹è¯•ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œæ¯æ¬¡æµ‹è¯•åè‡ªåŠ¨æ¸…ç†
3. **è®¤è¯**: æµ‹è¯•ä½¿ç”¨ JWT Token è¿›è¡Œè®¤è¯
4. **æƒé™**: æµ‹è¯•è¦†ç›–äº†ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·ä¸¤ç§è§’è‰²

## ğŸ”§ æµ‹è¯• Fixtures

æµ‹è¯•ä½¿ç”¨äº†ä»¥ä¸‹ Fixturesï¼ˆå®šä¹‰åœ¨ `test/conftest.py`ï¼‰:
- `api_client` - æœªè®¤è¯çš„ API å®¢æˆ·ç«¯
- `user` - æ™®é€šæµ‹è¯•ç”¨æˆ·
- `admin_user` - ç®¡ç†å‘˜ç”¨æˆ·
- `authenticated_client` - å·²è®¤è¯çš„ API å®¢æˆ·ç«¯
- `admin_client` - ç®¡ç†å‘˜ API å®¢æˆ·ç«¯
- `token_pair` - JWT Token å¯¹
- `admin_token_pair` - ç®¡ç†å‘˜ JWT Token å¯¹

## ğŸ“‹ å¾…å®Œæˆçš„æµ‹è¯•

1. **é›†æˆæµ‹è¯•**:
   - ç”¨æˆ·æ³¨å†Œ â†’ ç™»å½• â†’ è·å–ä¿¡æ¯ â†’ æ›´æ–°ä¿¡æ¯
   - è§’è‰²åˆ›å»º â†’ åˆ†é…è§’è‰² â†’ æ£€æŸ¥æƒé™

2. **è¾¹ç•Œæµ‹è¯•**:
   - å¤§é‡æ•°æ®çš„åˆ†é¡µæµ‹è¯•
   - å¹¶å‘è¯·æ±‚æµ‹è¯•
   - å¼‚å¸¸æƒ…å†µå¤„ç†æµ‹è¯•

3. **æ€§èƒ½æµ‹è¯•**:
   - API å“åº”æ—¶é—´æµ‹è¯•
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æµ‹è¯•

## âœ… æµ‹è¯•æ€»ç»“

### Phase 3: ç”¨æˆ·ç®¡ç†æ¨¡å—
- âœ… æ¨¡å‹å®šä¹‰æ­£ç¡®
- âœ… åºåˆ—åŒ–å™¨å®ç°å®Œæ•´
- âœ… è§†å›¾é›†åŠŸèƒ½å®Œæ•´
- âœ… æƒé™æ§åˆ¶æ­£ç¡®
- âœ… è·¯ç”±é…ç½®æ­£ç¡®
- â³ æµ‹è¯•ç”¨ä¾‹å·²åˆ›å»ºï¼Œå¾…è¿è¡ŒéªŒè¯

### Phase 4: æƒé™ç®¡ç†ç³»ç»Ÿ
- âœ… æ¨¡å‹å®šä¹‰æ­£ç¡®
- âœ… åºåˆ—åŒ–å™¨å®ç°å®Œæ•´
- âœ… è§†å›¾é›†åŠŸèƒ½å®Œæ•´
- âœ… æƒé™ç±»å®ç°æ­£ç¡®
- âœ… è£…é¥°å™¨å®ç°æ­£ç¡®
- âœ… å·¥å…·å‡½æ•°å®ç°æ­£ç¡®
- âœ… è·¯ç”±é…ç½®æ­£ç¡®
- â³ æµ‹è¯•ç”¨ä¾‹å·²åˆ›å»ºï¼Œå¾…è¿è¡ŒéªŒè¯

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ä¿®å¤æµ‹è¯•ç¯å¢ƒé—®é¢˜**:
   - è§£å†³ JWT ä¾èµ–é—®é¢˜
   - ç¡®ä¿æµ‹è¯•æ•°æ®åº“è¿ç§»æ­£ç¡®

2. **è¿è¡Œå®Œæ•´æµ‹è¯•**:
   - æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
   - ä¿®å¤å‘ç°çš„ bug
   - æå‡æµ‹è¯•è¦†ç›–ç‡åˆ° 80%+

3. **é›†æˆæµ‹è¯•**:
   - ç¼–å†™ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯
   - æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-12-06

